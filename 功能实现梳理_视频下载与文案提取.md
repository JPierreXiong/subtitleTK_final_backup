# åŠŸèƒ½å®ç°æ¢³ç†ï¼šè§†é¢‘ä¸‹è½½ä¸æ–‡æ¡ˆæå–

## ğŸ“‹ ç›®å½•
1. [è§†é¢‘ä¸‹è½½åŠŸèƒ½](#è§†é¢‘ä¸‹è½½åŠŸèƒ½)
2. [æ–‡æ¡ˆæå–åŠŸèƒ½](#æ–‡æ¡ˆæå–åŠŸèƒ½)
3. [æ•´ä½“æµç¨‹](#æ•´ä½“æµç¨‹)
4. [å…³é”®æ–‡ä»¶æ¸…å•](#å…³é”®æ–‡ä»¶æ¸…å•)

---

## ğŸ¬ è§†é¢‘ä¸‹è½½åŠŸèƒ½

### 1. åŠŸèƒ½æ¦‚è¿°
ä» TikTok æˆ– YouTube è·å–è§†é¢‘ä¸‹è½½é“¾æ¥ï¼Œå¹¶æ”¯æŒå°†è§†é¢‘ä¸Šä¼ åˆ°äº‘å­˜å‚¨ï¼ˆR2 æˆ– Vercel Blobï¼‰ã€‚

### 2. å®ç°ä½ç½®

#### 2.1 Worker ç«¯å®ç°ï¼ˆ`worker/download-video.ts`ï¼‰
- **ä¸»è¦å‡½æ•°**ï¼š
  - `downloadVideo(videoUrl, taskId)`: å•æ¬¡ä¸‹è½½è§†é¢‘
  - `downloadVideoWithRetry(videoUrl, taskId, maxRetries)`: å¸¦é‡è¯•æœºåˆ¶çš„ä¸‹è½½

- **æ ¸å¿ƒç‰¹æ€§**ï¼š
  - âœ… **æµå¼ä¸‹è½½**ï¼šä½¿ç”¨ `stream/promises.pipeline` é¿å…å†…å­˜æº¢å‡º
  - âœ… **è¶…æ—¶ä¿æŠ¤**ï¼š60ç§’è¶…æ—¶ï¼Œä½¿ç”¨ `AbortController`
  - âœ… **é‡è¯•æœºåˆ¶**ï¼šæœ€å¤š3æ¬¡é‡è¯•ï¼ŒæŒ‡æ•°é€€é¿ï¼ˆ1s, 2s, 4sï¼‰
  - âœ… **æ–‡ä»¶éªŒè¯**ï¼šä¸‹è½½åæ£€æŸ¥æ–‡ä»¶å¤§å°ï¼Œç¡®ä¿ä¸ä¸ºç©º
  - âœ… **é”™è¯¯æ¸…ç†**ï¼šå¤±è´¥æ—¶è‡ªåŠ¨åˆ é™¤ä¸´æ—¶æ–‡ä»¶

- **ä¸‹è½½æµç¨‹**ï¼š
  ```
  1. åˆ›å»ºä¸´æ—¶æ–‡ä»¶è·¯å¾„: /tmp/{taskId}-video.mp4
  2. è®¾ç½®60ç§’è¶…æ—¶
  3. ä½¿ç”¨ fetch ä¸‹è½½ï¼ˆå¸¦ User-Agentï¼‰
  4. æµå¼å†™å…¥æ–‡ä»¶
  5. éªŒè¯æ–‡ä»¶å¤§å°
  6. è¿”å›æ–‡ä»¶è·¯å¾„
  ```

#### 2.2 API è·¯ç”±å¤„ç†ï¼ˆ`src/app/api/media/submit/route.ts`ï¼‰
- **å¤„ç†é€»è¾‘**ï¼š
  - ä¼˜å…ˆæ£€æŸ¥è§†é¢‘ç¼“å­˜ï¼ˆ`findValidVideoCache`ï¼‰
  - ç¼“å­˜å‘½ä¸­ï¼šç›´æ¥ä½¿ç”¨ç¼“å­˜çš„ä¸‹è½½é“¾æ¥
  - ç¼“å­˜æœªå‘½ä¸­ï¼šè°ƒç”¨ RapidAPI è·å–è§†é¢‘ä¿¡æ¯

- **è§†é¢‘å­˜å‚¨ç­–ç•¥**ï¼š
  ```typescript
  if (platform === 'tiktok') {
    // TikTok: å°è¯•ä¸Šä¼ åˆ°äº‘å­˜å‚¨ï¼ˆR2 æˆ– Vercel Blobï¼‰
    const storageIdentifier = await uploadVideoToStorage(videoUrl);
    if (storageIdentifier) {
      videoUrlInternal = storageIdentifier; // å­˜å‚¨åœ¨äº‘å­˜å‚¨
      expiresAt = 24å°æ—¶;
    } else {
      videoUrlInternal = `original:${videoUrl}`; // ä½¿ç”¨åŸå§‹é“¾æ¥
      expiresAt = 2å°æ—¶;
    }
  } else if (platform === 'youtube') {
    // YouTube: ç›´æ¥ä½¿ç”¨åŸå§‹é“¾æ¥
    videoUrlInternal = `original:${videoUrl}`;
    expiresAt = 2å°æ—¶;
  }
  ```

#### 2.3 Worker ä»»åŠ¡å¤„ç†ï¼ˆ`worker/process-task.ts`ï¼‰
- **è§†é¢‘ä¸‹è½½æµç¨‹**ï¼š
  ```typescript
  if (outputType === 'video' && mediaInfo.videoUrl) {
    // 1. ä¸‹è½½è§†é¢‘åˆ°æœ¬åœ°
    videoPath = await downloadVideoWithRetry(mediaInfo.videoUrl, taskId);
    
    // 2. ç›®å‰ä½¿ç”¨åŸå§‹URLï¼ˆTODO: ä¸Šä¼ åˆ°å­˜å‚¨ï¼‰
    videoUrlInternal = `original:${mediaInfo.videoUrl}`;
    expiresAt = 2å°æ—¶;
    
    // 3. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    await cleanupTempFiles([videoPath]);
  }
  ```

### 3. ç›¸å…³æœåŠ¡

#### 3.1 è§†é¢‘å­˜å‚¨æœåŠ¡ï¼ˆ`src/shared/services/media/video-storage.ts`ï¼‰
- `uploadVideoToStorage(videoUrl)`: ä¸Šä¼ è§†é¢‘åˆ°äº‘å­˜å‚¨
- `uploadVideoToR2(videoUrl)`: ä¸Šä¼ åˆ° Cloudflare R2
- `getVideoDownloadUrl(storageIdentifier)`: è·å–ä¸‹è½½URLï¼ˆæ”¯æŒé¢„ç­¾åï¼‰

#### 3.2 è§†é¢‘ç¼“å­˜ï¼ˆ`src/shared/models/video_cache.ts`ï¼‰
- `findValidVideoCache(fingerprint)`: æŸ¥æ‰¾æœ‰æ•ˆç¼“å­˜
- `setVideoCache(fingerprint, data)`: è®¾ç½®ç¼“å­˜ï¼ˆ12å°æ—¶æœ‰æ•ˆæœŸï¼‰

#### 3.3 ä¸‹è½½ä»£ç†ï¼ˆ`src/app/api/media/download-proxy/route.ts`ï¼‰
- å‰ç«¯ä¸‹è½½å¤±è´¥æ—¶çš„å¤‡ç”¨æ–¹æ¡ˆ
- é€šè¿‡æœåŠ¡å™¨ä»£ç†ä¸‹è½½ï¼Œé¿å… CORS é—®é¢˜

---

## ğŸ“ æ–‡æ¡ˆæå–åŠŸèƒ½

### 1. åŠŸèƒ½æ¦‚è¿°
ä»è§†é¢‘å­—å¹•ï¼ˆSRTæ ¼å¼ï¼‰ä¸­æå–æ‘˜è¦ã€å…³é”®ç‚¹å’Œå¤§çº²ï¼Œä½¿ç”¨ Gemini API è¿›è¡Œæ™ºèƒ½åˆ†æã€‚

### 2. å®ç°ä½ç½®

#### 2.1 Worker ç«¯å®ç°ï¼ˆ`worker/extract-content.ts`ï¼‰
- **ä¸»è¦å‡½æ•°**ï¼š
  - `extractContent(subtitleRaw, targetLanguage)`: ä¸»æå–å‡½æ•°
  - `extractSummary(text)`: æå–æ‘˜è¦
  - `extractKeyPoints(text)`: æå–å…³é”®ç‚¹
  - `extractOutline(segments)`: æå–å¤§çº²

- **è¿”å›æ•°æ®ç»“æ„**ï¼š
  ```typescript
  interface ContentExtract {
    summary: string;        // 2-3å¥è¯æ‘˜è¦
    outline: string[];      // æ—¶é—´è½´å¤§çº²ï¼ˆæ¯30ç§’ä¸€æ®µï¼‰
    keyPoints: string[];    // 3-5ä¸ªå…³é”®ç‚¹
    duration: number;       // è§†é¢‘æ—¶é•¿ï¼ˆç§’ï¼‰
    language: string;       // ç›®æ ‡è¯­è¨€
  }
  ```

- **å¤„ç†æµç¨‹**ï¼š
  ```
  1. è§£æ SRT å­—å¹•ä¸ºæ—¶é—´ç‰‡æ®µï¼ˆSubtitleSegment[]ï¼‰
  2. æå–å®Œæ•´æ–‡æœ¬å†…å®¹
  3. å¦‚æœæŒ‡å®šç›®æ ‡è¯­è¨€ï¼Œå…ˆç¿»è¯‘å­—å¹•
  4. è°ƒç”¨ Gemini API æå–æ‘˜è¦ï¼ˆé™åˆ¶5000å­—ç¬¦ï¼‰
  5. è°ƒç”¨ Gemini API æå–å…³é”®ç‚¹ï¼ˆé™åˆ¶5000å­—ç¬¦ï¼‰
  6. æŒ‰æ—¶é—´åˆ‡å—ç”Ÿæˆå¤§çº²ï¼ˆæ¯30ç§’ä¸€æ®µï¼Œæœ€å¤š10æ®µï¼‰
  7. è¿”å›æå–ç»“æœ
  ```

#### 2.2 å­—å¹•è§£æ
- **SRT è§£æ**ï¼š
  - `parseSRTToSegments(srtContent)`: è§£æ SRT ä¸ºæ—¶é—´ç‰‡æ®µ
  - `parseSRTTime(hours, minutes, seconds, millis)`: æ—¶é—´æˆ³è½¬ç§’æ•°

- **æ—¶é—´åˆ‡å—**ï¼š
  - `extractOutline(segments)`: æŒ‰30ç§’åˆ‡å—ï¼Œæå–æ¯æ®µçš„ç¬¬ä¸€å¥è¯
  - æ ¼å¼ï¼š`"1:23 - ç¬¬ä¸€å¥è¯å†…å®¹..."`

#### 2.3 Gemini API é›†æˆ
- **æœåŠ¡ä½ç½®**ï¼š`src/shared/services/media/gemini-translator.ts`
- **ä¸»è¦å‡½æ•°**ï¼š
  - `translateSubtitleWithGemini(srtContent, targetLanguage)`: ç¿»è¯‘å­—å¹•
  - æ–‡æ¡ˆæå–å¤ç”¨ç¿»è¯‘å‡½æ•°ï¼Œé€šè¿‡ä¸åŒçš„ Prompt å®ç°

- **æ‘˜è¦æå– Prompt**ï¼š
  ```
  Summarize the following video content in 2-3 sentences:
  
  {text.substring(0, 5000)}
  
  Summary:
  ```

- **å…³é”®ç‚¹æå– Prompt**ï¼š
  ```
  Extract 3-5 key points from the following video content:
  
  {text.substring(0, 5000)}
  
  Key points (one per line):
  ```

### 3. å½“å‰çŠ¶æ€

#### âœ… å·²å®ç°
- SRT å­—å¹•è§£æ
- æ‘˜è¦æå–ï¼ˆ2-3å¥è¯ï¼‰
- å…³é”®ç‚¹æå–ï¼ˆ3-5ä¸ªï¼‰
- æ—¶é—´è½´å¤§çº²ç”Ÿæˆï¼ˆæ¯30ç§’ä¸€æ®µï¼‰
- å¤šè¯­è¨€æ”¯æŒï¼ˆå…ˆç¿»è¯‘å†æå–ï¼‰

#### âš ï¸ æ³¨æ„äº‹é¡¹
- **æ–‡æ¡ˆæå–ç›®å‰æœªåœ¨ä¸»æµç¨‹ä¸­è°ƒç”¨**ï¼š
  - `worker/process-task.ts` ä¸­**æ²¡æœ‰è°ƒç”¨** `extractContent`
  - `src/app/api/media/submit/route.ts` ä¸­**æ²¡æœ‰è°ƒç”¨** `extractContent`
  - åŠŸèƒ½å·²å®ç°ï¼Œä½†éœ€è¦é›†æˆåˆ°ä¸»æµç¨‹ä¸­

- **Gemini API ä½¿ç”¨**ï¼š
  - æ–‡æ¡ˆæå–å¤ç”¨ `translateSubtitleWithGemini` å‡½æ•°
  - é€šè¿‡ä¸åŒçš„ Prompt å®ç°ä¸åŒåŠŸèƒ½
  - å»ºè®®ï¼šåˆ›å»ºä¸“é—¨çš„ `generateSummary` å’Œ `generateKeyPoints` å‡½æ•°

---

## ğŸ”„ æ•´ä½“æµç¨‹

### ä»»åŠ¡æäº¤æµç¨‹ï¼ˆ`src/app/api/media/submit/route.ts`ï¼‰

```
ç”¨æˆ·æäº¤ä»»åŠ¡
    â†“
éªŒè¯ URL å’Œæƒé™
    â†“
æ£€æŸ¥ç§¯åˆ†å’Œè®¡åˆ’é™åˆ¶
    â†“
åˆ›å»ºä»»åŠ¡ï¼ˆcreateMediaTaskï¼‰
    â†“
æ¶ˆè´¹ç§¯åˆ†ï¼ˆå¦‚æœä¸æ˜¯å…è´¹è¯•ç”¨ï¼‰
    â†“
é€‰æ‹©å¤„ç†æ–¹å¼ï¼š
  â”œâ”€ Worker æ¨¡å¼ï¼ˆQStash Queueï¼‰â†’ worker/process-task.ts
  â””â”€ setTimeout æ¨¡å¼ â†’ æœ¬åœ° processMediaTask å‡½æ•°
```

### è§†é¢‘ä¸‹è½½æµç¨‹

```
processMediaTask (submit/route.ts æˆ– worker/process-task.ts)
    â†“
æ£€æŸ¥è§†é¢‘ç¼“å­˜
    â”œâ”€ ç¼“å­˜å‘½ä¸­ â†’ ç›´æ¥ä½¿ç”¨ç¼“å­˜é“¾æ¥
    â””â”€ ç¼“å­˜æœªå‘½ä¸­ â†’ è°ƒç”¨ RapidAPI
    â†“
è·å–è§†é¢‘ä¿¡æ¯ï¼ˆRapidAPIï¼‰
    â†“
å¤„ç†è§†é¢‘ä¸‹è½½ï¼š
    â”œâ”€ TikTok: å°è¯•ä¸Šä¼ åˆ°äº‘å­˜å‚¨ â†’ å¤±è´¥åˆ™ä½¿ç”¨åŸå§‹é“¾æ¥
    â””â”€ YouTube: ç›´æ¥ä½¿ç”¨åŸå§‹é“¾æ¥
    â†“
ä¿å­˜ videoUrlInternal å’Œ expiresAt
    â†“
æ ‡è®°ä»»åŠ¡ä¸º 'extracted'
```

### å­—å¹•æå–æµç¨‹

```
processMediaTask
    â†“
è°ƒç”¨ RapidAPI è·å–åª’ä½“ä¿¡æ¯
    â†“
æ£€æŸ¥æ˜¯å¦æœ‰å­—å¹•ï¼ˆmediaInfo.subtitleRawï¼‰
    â”œâ”€ æœ‰å­—å¹• â†’ ç›´æ¥ä½¿ç”¨
    â””â”€ æ— å­—å¹• â†’ ä¸‹è½½è§†é¢‘ â†’ æå–éŸ³é¢‘ â†’ ASRï¼ˆç›®å‰æœªå®ç°ï¼‰
    â†“
ä¿å­˜ subtitleRaw åˆ°æ•°æ®åº“
    â†“
æ ‡è®°ä»»åŠ¡ä¸º 'extracted'
```

### æ–‡æ¡ˆæå–æµç¨‹ï¼ˆå½“å‰æœªé›†æˆï¼‰

```
ä»»åŠ¡å®Œæˆåï¼ˆstatus = 'extracted'ï¼‰
    â†“
è¯»å– subtitleRaw
    â†“
è°ƒç”¨ extractContent(subtitleRaw, targetLanguage)
    â†“
è§£æ SRT â†’ æå–æ–‡æœ¬
    â†“
ï¼ˆå¯é€‰ï¼‰ç¿»è¯‘å­—å¹•
    â†“
è°ƒç”¨ Gemini APIï¼š
    â”œâ”€ æå–æ‘˜è¦
    â”œâ”€ æå–å…³é”®ç‚¹
    â””â”€ ç”Ÿæˆå¤§çº²
    â†“
è¿”å› ContentExtract å¯¹è±¡
    â†“
ï¼ˆéœ€è¦ï¼‰ä¿å­˜åˆ°æ•°æ®åº“
```

---

## ğŸ“ å…³é”®æ–‡ä»¶æ¸…å•

### è§†é¢‘ä¸‹è½½ç›¸å…³
```
worker/download-video.ts              # Worker ç«¯ä¸‹è½½å®ç°
src/app/api/media/submit/route.ts     # API è·¯ç”±ï¼Œå¤„ç†è§†é¢‘ä¸‹è½½é€»è¾‘
src/app/api/media/download-proxy/route.ts  # ä¸‹è½½ä»£ç†ï¼ˆå¤‡ç”¨ï¼‰
src/shared/services/media/video-storage.ts  # äº‘å­˜å‚¨æœåŠ¡
src/shared/models/video_cache.ts      # è§†é¢‘ç¼“å­˜æ¨¡å‹
worker/process-task.ts                # Worker ä»»åŠ¡å¤„ç†ï¼ˆåŒ…å«è§†é¢‘ä¸‹è½½ï¼‰
```

### æ–‡æ¡ˆæå–ç›¸å…³
```
worker/extract-content.ts             # æ–‡æ¡ˆæå–ä¸»å®ç°
src/shared/services/media/gemini-translator.ts  # Gemini API æœåŠ¡
worker/transcribe.ts                  # å­—å¹•å¤„ç†ï¼ˆåŒ…å« SRT è§£æï¼‰
```

### æ ¸å¿ƒæœåŠ¡
```
src/shared/services/media/rapidapi.ts  # RapidAPI æœåŠ¡å°è£…
src/extensions/media/rapidapi.ts       # RapidAPI Provider å®ç°
src/shared/models/media_task.ts        # ä»»åŠ¡æ¨¡å‹
```

### é…ç½®æ–‡ä»¶
```
worker/package.json                   # Worker ä¾èµ–
worker/Dockerfile                     # Worker Docker é•œåƒ
src/config/db/schema.ts               # æ•°æ®åº“ Schema
```

---

## ğŸ” å…³é”®ä»£ç ç‰‡æ®µ

### è§†é¢‘ä¸‹è½½ï¼ˆå¸¦é‡è¯•ï¼‰
```typescript
// worker/download-video.ts
export async function downloadVideoWithRetry(
  videoUrl: string,
  taskId: string,
  maxRetries = 3
): Promise<string> {
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      return await downloadVideo(videoUrl, taskId);
    } catch (error) {
      if (attempt < maxRetries) {
        const delay = 1000 * Math.pow(2, attempt - 1); // æŒ‡æ•°é€€é¿
        await sleep(delay);
      }
    }
  }
  throw new Error(`Download failed after ${maxRetries} attempts`);
}
```

### æ–‡æ¡ˆæå–
```typescript
// worker/extract-content.ts
export async function extractContent(
  subtitleRaw: string,
  targetLanguage?: string
): Promise<ContentExtract> {
  // 1. è§£æ SRT
  const segments = parseSRTToSegments(subtitleRaw);
  const fullText = segments.map(seg => seg.text).join(' ');
  
  // 2. å¯é€‰ç¿»è¯‘
  let contentText = fullText;
  if (targetLanguage && targetLanguage !== 'auto') {
    const translatedSRT = await translateSubtitleWithGemini(
      subtitleRaw,
      targetLanguage
    );
    contentText = parseSRTToSegments(translatedSRT)
      .map(seg => seg.text)
      .join(' ');
  }
  
  // 3. æå–å†…å®¹
  const summary = await extractSummary(contentText);
  const keyPoints = await extractKeyPoints(contentText);
  const outline = await extractOutline(segments);
  
  return { summary, outline, keyPoints, duration, language };
}
```

---

## âš ï¸ å¾…å®Œå–„äº‹é¡¹

1. **æ–‡æ¡ˆæå–æœªé›†æˆ**ï¼š
   - éœ€è¦åœ¨ä»»åŠ¡å®Œæˆåè°ƒç”¨ `extractContent`
   - éœ€è¦å°†æå–ç»“æœä¿å­˜åˆ°æ•°æ®åº“
   - éœ€è¦åœ¨å‰ç«¯å±•ç¤ºæå–ç»“æœ

2. **Worker ç«¯è§†é¢‘ä¸Šä¼ **ï¼š
   - `worker/process-task.ts` ä¸­è§†é¢‘ä¸‹è½½åæœªä¸Šä¼ åˆ°å­˜å‚¨
   - ç›®å‰ä½¿ç”¨åŸå§‹é“¾æ¥ï¼ˆ`original:${videoUrl}`ï¼‰
   - éœ€è¦å®ç°ä¸Šä¼ é€»è¾‘

3. **Gemini API ä¼˜åŒ–**ï¼š
   - æ–‡æ¡ˆæå–å¤ç”¨ç¿»è¯‘å‡½æ•°ï¼Œå»ºè®®åˆ›å»ºä¸“é—¨å‡½æ•°
   - å¯ä»¥ä¼˜åŒ– Prompt ä»¥æé«˜æå–è´¨é‡

4. **é”™è¯¯å¤„ç†**ï¼š
   - æ–‡æ¡ˆæå–å¤±è´¥æ—¶çš„é™çº§ç­–ç•¥
   - è§†é¢‘ä¸‹è½½å¤±è´¥æ—¶çš„ç”¨æˆ·æç¤º

---

## ğŸ“Š æ•°æ®æµå›¾

```
ç”¨æˆ·æäº¤
    â†“
API Route (submit/route.ts)
    â†“
åˆ›å»ºä»»åŠ¡ + æ¶ˆè´¹ç§¯åˆ†
    â†“
å¼‚æ­¥å¤„ç†ï¼ˆWorker æˆ– setTimeoutï¼‰
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  processMediaTask                   â”‚
â”‚                                     â”‚
â”‚  1. RapidAPI è·å–åª’ä½“ä¿¡æ¯           â”‚
â”‚  2. å¤„ç†å­—å¹•ï¼ˆsubtitleRawï¼‰         â”‚
â”‚  3. å¤„ç†è§†é¢‘ï¼ˆvideoUrlInternalï¼‰   â”‚
â”‚  4. ä¿å­˜åˆ°æ•°æ®åº“                     â”‚
â”‚  5. æ ‡è®°ä¸º 'extracted'              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
ï¼ˆå¯é€‰ï¼‰æ–‡æ¡ˆæå–
    â†“
extractContent(subtitleRaw)
    â†“
Gemini API åˆ†æ
    â†“
è¿”å›æ‘˜è¦ã€å…³é”®ç‚¹ã€å¤§çº²
```

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2024-12-19
**æœ€åæ›´æ–°**: åŸºäºå½“å‰ä»£ç åº“çŠ¶æ€
