# waitUntil é›†æˆå®Œæˆæ€»ç»“

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. å®‰è£…ä¾èµ– âœ…

**å‘½ä»¤ï¼š** `pnpm add @vercel/functions`

**ç»“æœï¼š** âœ… æˆåŠŸå®‰è£… `@vercel/functions@3.3.5`

### 2. é›†æˆ waitUntil ä½œä¸º P0 ä¼˜å…ˆçº§ âœ…

**æ–‡ä»¶ï¼š** `src/app/api/media/submit/route.ts`

**ä¿®æ”¹å†…å®¹ï¼š**
- âœ… å¯¼å…¥ `waitUntil` from `@vercel/functions`
- âœ… æ·»åŠ  `maxDuration = 180` é…ç½®ï¼ˆ3åˆ†é’Ÿï¼Œé€‚ç”¨äº Vercel Pro ç‰ˆï¼‰
- âœ… å®ç°å¤šå±‚é™çº§ç­–ç•¥ï¼š
  - **P0**: `waitUntil` - Vercel åŸç”Ÿæ–¹æ¡ˆï¼Œé›¶æˆæœ¬ï¼Œæœ€ä½³æ€§èƒ½
  - **P1**: Worker/Queue (QStash) - é«˜å¹¶å‘åœºæ™¯æœ€å¯é 
  - **P2**: Internal Processing Endpoint - æ¯” setTimeout æ›´å¯é 
  - **P3**: setTimeout - æœ€åé™çº§æ–¹æ¡ˆ

### 3. ä¼˜åŒ–å†…éƒ¨å¤„ç†æ¥å£ âœ…

**æ–‡ä»¶ï¼š** `src/app/api/media/process-internal/route.ts`

**ä¿®æ”¹å†…å®¹ï¼š**
- âœ… æ·»åŠ  `maxDuration = 180` é…ç½®

---

## ğŸ¯ æ–°çš„é™çº§ç­–ç•¥æ¶æ„

```
ç”¨æˆ·æäº¤ä»»åŠ¡
    â†“
åˆ›å»ºä»»åŠ¡ + æ¶ˆè´¹ç§¯åˆ†
    â†“
å°è¯• waitUntil (P0)
    â”œâ”€ æˆåŠŸ â†’ ä»»åŠ¡åœ¨åå°æ‰§è¡Œï¼Œç«‹å³è¿”å›å“åº”
    â”‚         â†“
    â”‚      processMediaTask æ‰§è¡Œ
    â”‚         â†“
    â”‚      æ›´æ–°æ•°æ®åº“çŠ¶æ€
    â”‚
    â””â”€ å¤±è´¥ â†’ é™çº§åˆ° P1
                â†“
           æ£€æŸ¥ Worker/Queue
                â”œâ”€ å¯ç”¨ â†’ QStash Queue
                â”‚         â†“
                â”‚      å¤±è´¥ â†’ é™çº§åˆ° P2
                â”‚
                â””â”€ æœªå¯ç”¨ â†’ ç›´æ¥ä½¿ç”¨ P2
                            â†“
                        Internal Processing Endpoint
                            â†“
                        å¤±è´¥ â†’ é™çº§åˆ° P3
                            â†“
                        setTimeout
```

---

## ğŸ’¡ waitUntil çš„ä¼˜åŠ¿

### 1. é›¶æˆæœ¬
- âœ… å®Œå…¨å…è´¹ï¼ŒåŒ…å«åœ¨ Vercel è®¡åˆ’ä¸­
- âœ… æ— éœ€å¤–éƒ¨ API è°ƒç”¨
- âœ… æ— éœ€é¢å¤–çš„æœåŠ¡å™¨å®ä¾‹

### 2. æœ€ä½³æ€§èƒ½
- âœ… é›¶å»¶è¿Ÿå“åº”ï¼ˆç”¨æˆ·ç«‹å³æ”¶åˆ° taskIdï¼‰
- âœ… å…±äº«è¯·æ±‚ä¸Šä¸‹æ–‡ï¼ˆè‡ªåŠ¨å¤„ç† Cookie/Authï¼‰
- âœ… æ— éœ€é‡æ–°å»ºç«‹è¿æ¥

### 3. æ™ºèƒ½èµ„æºç®¡ç†
- âœ… Vercel è‡ªåŠ¨ç­‰å¾… Promise å®Œæˆ
- âœ… é…åˆ `maxDuration` å¯æ‰§è¡Œé•¿æ—¶é—´ä»»åŠ¡
- âœ… è‡ªåŠ¨å¤„ç†å®ä¾‹ç”Ÿå‘½å‘¨æœŸ

### 4. ä»£ç ç®€æ´
- âœ… åªéœ€ä¸€è¡Œä»£ç ï¼š`waitUntil(processMediaTask(...))`
- âœ… æ— éœ€é¢å¤–çš„é”™è¯¯å¤„ç†ï¼ˆprocessMediaTask å†…éƒ¨å·²å¤„ç†ï¼‰
- âœ… ä¿æŒä»£ç æ¸…æ™°æ˜“è¯»

---

## ğŸ“‹ ä»£ç å®ç°ç»†èŠ‚

### 1. waitUntil é›†æˆ

```typescript
// P0: Try waitUntil first (native Vercel solution)
try {
  waitUntil(
    processMediaTask(taskId, url, outputType || 'subtitle', currentUser.id)
      .then(() => {
        console.log(`[waitUntil] Task ${taskId} completed successfully`);
      })
      .catch(async (error: any) => {
        console.error('[waitUntil] Task processing failed', {
          taskId,
          error: error.message,
        });
        // Error handling is done inside processMediaTask
      })
  );
  console.log(`[waitUntil] Task ${taskId} processing started via waitUntil`);
} catch (waitUntilError: any) {
  // Fallback to other strategies if waitUntil fails
  // ...
}
```

### 2. maxDuration é…ç½®

```typescript
// åœ¨è·¯ç”±æ–‡ä»¶é¡¶éƒ¨æ·»åŠ 
export const maxDuration = 180; // 3 minutes (for Vercel Pro tier)
```

**æ³¨æ„ï¼š**
- Vercel Free ç‰ˆï¼šæœ€å¤§ 10 ç§’ï¼ˆæ— æ³•é…ç½®ï¼‰
- Vercel Pro ç‰ˆï¼šæœ€å¤§ 300 ç§’ï¼ˆå¯é…ç½®ï¼‰
- å½“å‰é…ç½®ï¼š180 ç§’ï¼ˆ3åˆ†é’Ÿï¼‰ï¼Œé€‚åˆå¤§å¤šæ•°è§†é¢‘å¤„ç†ä»»åŠ¡

### 3. å¤šå±‚é™çº§ç­–ç•¥

```typescript
// P0: waitUntil (å°è¯•)
// P1: QStash Queue (å¦‚æœå¯ç”¨)
// P2: Internal Processing Endpoint
// P3: setTimeout (æœ€åé™çº§)
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. Vercel ç‰ˆæœ¬é™åˆ¶

- **Free ç‰ˆ**ï¼š`waitUntil` å¯ç”¨ï¼Œä½† `maxDuration` é™åˆ¶ä¸º 10 ç§’
- **Pro ç‰ˆ**ï¼š`waitUntil` å¯ç”¨ï¼Œ`maxDuration` å¯é…ç½®åˆ° 300 ç§’

### 2. å¹¶å‘é™åˆ¶

- `waitUntil` ä»å— Vercel å®ä¾‹å¹¶å‘é™åˆ¶
- é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼ŒQStash Queue æ›´å¯é 
- è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¿ç•™å¤šå±‚é™çº§ç­–ç•¥

### 3. é”™è¯¯å¤„ç†

- `processMediaTask` å†…éƒ¨å·²æœ‰å®Œæ•´çš„é”™è¯¯å¤„ç†
- `waitUntil` ä¸­çš„ `.catch()` ä¸»è¦ç”¨äºæ—¥å¿—è®°å½•
- ä»»åŠ¡å¤±è´¥æ—¶ä¼šè‡ªåŠ¨æ›´æ–°çŠ¶æ€å¹¶è§¦å‘ç§¯åˆ†é€€æ¬¾

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| æ–¹æ¡ˆ | æˆæœ¬ | å»¶è¿Ÿ | å¯é æ€§ | é€‚ç”¨åœºæ™¯ |
|------|------|------|--------|----------|
| **waitUntil (P0)** | $0 | 0ms | â­â­â­â­ | æ ‡å‡†åœºæ™¯ï¼ˆæ¨èï¼‰ |
| **QStash Queue (P1)** | å…è´¹é¢åº¦å……è¶³ | ~100ms | â­â­â­â­â­ | é«˜å¹¶å‘åœºæ™¯ |
| **Internal Endpoint (P2)** | $0 | ~50ms | â­â­â­ | é™çº§åœºæ™¯ |
| **setTimeout (P3)** | $0 | 100ms | â­â­ | æœ€åé™çº§ |

---

## âœ… æµ‹è¯•å»ºè®®

### 1. åŠŸèƒ½æµ‹è¯•
- [ ] æµ‹è¯• waitUntil è·¯å¾„ï¼ˆæ­£å¸¸åœºæ™¯ï¼‰
- [ ] æµ‹è¯• waitUntil å¤±è´¥æ—¶çš„é™çº§è·¯å¾„
- [ ] æµ‹è¯•æ‰€æœ‰é™çº§è·¯å¾„çš„å®Œæ•´æ€§
- [ ] éªŒè¯ä»»åŠ¡èƒ½æ­£ç¡®æ‰§è¡Œå’Œå®Œæˆ

### 2. æ€§èƒ½æµ‹è¯•
- [ ] éªŒè¯å“åº”æ—¶é—´ï¼ˆåº”è¯¥ < 1 ç§’ï¼‰
- [ ] éªŒè¯ä»»åŠ¡æ‰§è¡Œæ—¶é—´ï¼ˆåº”è¯¥ < 3 åˆ†é’Ÿï¼‰
- [ ] éªŒè¯çŠ¶æ€æ›´æ–°æ­£ç¡®æ€§

### 3. é”™è¯¯å¤„ç†æµ‹è¯•
- [ ] æµ‹è¯•ä»»åŠ¡å¤±è´¥æ—¶çš„çŠ¶æ€æ›´æ–°
- [ ] æµ‹è¯•ç§¯åˆ†é€€æ¬¾é€»è¾‘
- [ ] æµ‹è¯•é”™è¯¯æ—¥å¿—è®°å½•

---

## ğŸ¯ å®æ–½ç»“æœ

### æ ¸å¿ƒä¼˜åŠ¿
âœ… **é›¶æˆæœ¬**ï¼šwaitUntil å®Œå…¨å…è´¹  
âœ… **æœ€ä½³æ€§èƒ½**ï¼šé›¶å»¶è¿Ÿå“åº”ï¼Œå…±äº«ä¸Šä¸‹æ–‡  
âœ… **æ™ºèƒ½é™çº§**ï¼šå››å±‚é™çº§ç­–ç•¥ç¡®ä¿ä»»åŠ¡æ‰§è¡Œ  
âœ… **ä»£ç ç®€æ´**ï¼šåªéœ€ä¸€è¡Œä»£ç é›†æˆ  

### ShipAny ç»“æ„ä¿æŠ¤
âœ… **æœªæ”¹åŠ¨**ï¼šåªæ·»åŠ å¯¼å…¥å’Œè°ƒç”¨  
âœ… **å‘åå…¼å®¹**ï¼šä¿ç•™æ‰€æœ‰ç°æœ‰åŠŸèƒ½  
âœ… **æ˜“äºç»´æŠ¤**ï¼šæ¸…æ™°çš„ä¼˜å…ˆçº§ç­–ç•¥  

### ä»£ç è´¨é‡
âœ… **æ—  Linter é”™è¯¯**ï¼šæ‰€æœ‰ä»£ç é€šè¿‡æ£€æŸ¥  
âœ… **å®Œæ•´é”™è¯¯å¤„ç†**ï¼šå¤šå±‚é”™è¯¯æ•è·  
âœ… **è¯¦ç»†æ—¥å¿—è®°å½•**ï¼šä¾¿äºè°ƒè¯•å’Œç›‘æ§  

---

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

### 1. ç›‘æ§å’Œæ—¥å¿—
- æ·»åŠ  waitUntil ä½¿ç”¨ç‡ç»Ÿè®¡
- æ·»åŠ å„é™çº§è·¯å¾„çš„ä½¿ç”¨ç»Ÿè®¡
- æ·»åŠ ä»»åŠ¡æ‰§è¡Œæ—¶é—´ç›‘æ§

### 2. æ€§èƒ½ä¼˜åŒ–
- è€ƒè™‘æ·»åŠ ä»»åŠ¡ä¼˜å…ˆçº§é˜Ÿåˆ—
- è€ƒè™‘æ·»åŠ ä»»åŠ¡é‡è¯•æœºåˆ¶
- è€ƒè™‘æ·»åŠ ä»»åŠ¡è¶…æ—¶æ£€æµ‹

### 3. æˆæœ¬ä¼˜åŒ–
- ç›‘æ§ Vercel Blob å¸¦å®½ä½¿ç”¨
- å®ç°è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ–‡ä»¶
- ä¼˜åŒ–è§†é¢‘ç¼“å­˜ç­–ç•¥

---

**å®æ–½å®Œæˆæ—¶é—´ï¼š** 2024-12-19  
**å®æ–½çŠ¶æ€ï¼š** âœ… å…¨éƒ¨å®Œæˆ  
**ä»£ç è´¨é‡ï¼š** âœ… é€šè¿‡æ£€æŸ¥  
**å‘åå…¼å®¹ï¼š** âœ… å®Œå…¨å…¼å®¹
