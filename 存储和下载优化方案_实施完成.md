# 存储和下载优化方案 - 实施完成

## ✅ 已完成的工作

### 1. 任务缓存服务 ✅

**文件：** `src/shared/services/media/task-cache.ts`

**功能：**
- ✅ 查找24小时内相同URL和outputType的已完成任务
- ✅ 支持 `extracted` 和 `completed` 状态的任务
- ✅ 自动检查视频是否过期
- ✅ 完整的数据验证（确保有必需的数据）

**成本节省：**
- 热门视频（1000次下载）只需1次RapidAPI调用
- 节省约 $50/热门视频（假设每次调用 $0.05）

### 2. 缓存检查集成 ✅

**文件：** `src/app/api/media/submit/route.ts`

**修改内容：**
- ✅ 在提交接口最前端添加缓存检查（P-1优先级）
- ✅ 缓存命中时直接创建任务，跳过RapidAPI调用
- ✅ 保留所有元数据和结果数据
- ✅ 完整的错误处理（缓存失败时继续正常流程）

**流程：**
```
用户提交 → 缓存检查 (P-1)
    ├─ 命中 → 创建任务（复用数据）→ 立即返回
    └─ 未命中 → 继续正常流程 (P0-P3)
```

### 3. 多格式下载工具 ✅

**文件：** `src/shared/utils/subtitle-download.ts`

**功能：**
- ✅ `downloadSRT()` - 下载标准SRT格式
- ✅ `downloadTXT()` - 下载纯文本（无时间戳）
- ✅ `downloadVTT()` - 下载WebVTT格式（网页字幕）
- ✅ `getSubtitleText()` - 提取纯文本内容

**优势：**
- 所有处理在浏览器完成，无需服务器生成文件
- 零服务器成本
- 支持多种格式，满足不同需求

### 4. 前端下载组件优化 ✅

**文件：** `src/shared/blocks/generator/media.tsx`

**修改内容：**
- ✅ 集成多格式下载工具
- ✅ 添加SRT/TXT/VTT三种格式下载按钮
- ✅ 保持现有UI风格和用户体验

### 5. 存储清理服务 ✅

**文件：** `src/shared/services/media/storage-cleanup.ts`

**功能：**
- ✅ 查找过期的视频任务
- ✅ 从Vercel Blob提取文件标识
- ✅ 批量删除过期文件
- ✅ 存储统计功能

**API端点：** `src/app/api/media/cleanup-storage/route.ts`
- ✅ POST - 执行清理（支持dryRun模式）
- ✅ GET - 获取存储统计

---

## 🎯 核心优化策略

### 1. 降低RapidAPI成本

**策略：** 任务级缓存（24小时）

**实现：**
- 查找相同URL和outputType的已完成任务
- 复用 `subtitleRaw` 和 `videoUrlInternal`
- 跳过RapidAPI调用

**收益：**
- 热门视频：节省 99%+ 的API调用
- 普通视频：节省重复请求

### 2. 降低存储成本

**策略：** 自动清理过期文件

**实现：**
- 24小时TTL（生存时间）
- 定时清理任务（Cron Job）
- 批量删除过期Blob文件

**收益：**
- 防止存储空间无限增长
- 保持在Vercel Blob免费额度内

### 3. 提升用户体验

**策略：** 多格式下载 + 缓存加速

**实现：**
- SRT/TXT/VTT三种格式
- 缓存命中时秒级响应
- 浏览器端格式转换（零服务器成本）

**收益：**
- 用户可选择最适合的格式
- 热门视频几乎瞬间完成

---

## 📋 技术实现细节

### 1. 缓存检查逻辑

```typescript
// 查找24小时内相同URL和outputType的已完成任务
const cachedTask = await findCachedTask(url, outputType);

if (cachedTask) {
  // 创建新任务，复用缓存数据
  // 跳过RapidAPI调用，节省成本
  // 立即返回结果
}
```

### 2. 多格式下载

```typescript
// SRT格式（标准）
downloadSRT(srtContent, 'subtitle');

// TXT格式（纯文本，无时间戳）
downloadTXT(srtContent, 'subtitle');

// VTT格式（网页字幕）
downloadVTT(srtContent, 'subtitle');
```

### 3. 存储清理

```typescript
// 查找过期任务
const expiredTasks = await findExpiredTasks();

// 批量删除Blob文件
for (const task of expiredTasks) {
  await del(extractBlobKey(task.videoUrlInternal));
}
```

---

## 🔧 配置建议

### 1. Vercel Cron Job（存储清理）

在 `vercel.json` 中添加：

```json
{
  "crons": [
    {
      "path": "/api/media/cleanup-storage",
      "schedule": "0 3 * * *"
    }
  ]
}
```

**说明：**
- 每天凌晨3点执行清理
- 自动删除过期文件
- 保持存储空间在合理范围

### 2. 数据库索引优化

确保 `media_tasks` 表有以下索引：

```sql
-- URL索引（用于缓存查找）
CREATE INDEX idx_media_task_url_output ON media_tasks(video_url, output_type, status, created_at);

-- 过期时间索引（用于清理）
CREATE INDEX idx_media_task_expires ON media_tasks(expires_at);
```

---

## 📊 成本分析

### RapidAPI成本节省

**场景：** 热门TikTok视频，1000次下载

**无缓存：**
- 1000次 × $0.05 = $50

**有缓存：**
- 1次 × $0.05 = $0.05
- **节省：$49.95 (99.9%)**

### 存储成本控制

**策略：** 24小时TTL + 自动清理

**效果：**
- 存储空间保持在合理范围
- 避免无限增长
- 符合Vercel Blob免费额度

---

## ✅ 测试建议

### 1. 缓存功能测试
- [ ] 测试缓存命中场景
- [ ] 测试缓存未命中场景
- [ ] 测试过期缓存处理
- [ ] 验证数据完整性

### 2. 下载功能测试
- [ ] 测试SRT格式下载
- [ ] 测试TXT格式下载
- [ ] 测试VTT格式下载
- [ ] 验证文件内容正确性

### 3. 存储清理测试
- [ ] 测试清理API（dryRun模式）
- [ ] 测试实际清理
- [ ] 验证统计功能
- [ ] 测试Cron Job触发

---

## 🎯 后续优化建议

### 1. 缓存统计
- 添加缓存命中率统计
- 记录节省的API调用次数
- 显示成本节省数据

### 2. 智能缓存
- 根据视频热度调整缓存时间
- 热门视频延长缓存时间
- 冷门视频缩短缓存时间

### 3. 下载优化
- 添加批量下载功能
- 支持ZIP打包下载
- 添加下载进度显示

---

## 📝 文件清单

### 新增文件
1. ✅ `src/shared/services/media/task-cache.ts` - 任务缓存服务
2. ✅ `src/shared/utils/subtitle-download.ts` - 多格式下载工具
3. ✅ `src/shared/services/media/storage-cleanup.ts` - 存储清理服务
4. ✅ `src/app/api/media/cleanup-storage/route.ts` - 清理API端点

### 修改文件
1. ✅ `src/app/api/media/submit/route.ts` - 添加缓存检查
2. ✅ `src/shared/blocks/generator/media.tsx` - 优化下载组件

---

**实施完成时间：** 2024-12-19  
**实施状态：** ✅ 全部完成  
**代码质量：** ✅ 通过检查  
**向后兼容：** ✅ 完全兼容  
**ShipAny结构：** ✅ 未改动
