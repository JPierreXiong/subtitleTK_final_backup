# Supabase æ•°æ®åº“è¿æ¥æ¸…ç†æŒ‡å—

## âš ï¸ æƒé™è¯´æ˜

åœ¨ Supabase ä¸­ï¼Œ**æ™®é€šç”¨æˆ·æ— æ³•ç»ˆæ­¢å…¶ä»–ç”¨æˆ·çš„è¿æ¥**ï¼ŒåŒ…æ‹¬ï¼š
- å…¶ä»–åº”ç”¨ç”¨æˆ·çš„è¿æ¥
- ç³»ç»Ÿè¿›ç¨‹çš„è¿æ¥
- è¶…çº§ç”¨æˆ·è¿›ç¨‹çš„è¿æ¥

**é”™è¯¯ä¿¡æ¯**ï¼š
```
ERROR: 42501: permission denied to terminate process
DETAIL: Only roles with the SUPERUSER attribute may terminate processes...
```

è¿™æ˜¯ **æ­£å¸¸çš„å®‰å…¨é™åˆ¶**ï¼Œä¸æ˜¯ bugã€‚

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: åªæ¸…ç†è‡ªå·±çš„è¿æ¥ï¼ˆæ¨èï¼‰

ä½¿ç”¨ `scripts/supabase_safe_cleanup.sql`ï¼š

```sql
-- åªç»ˆæ­¢ä½ è‡ªå·±çš„ç©ºé—²è¿æ¥
SELECT pg_terminate_backend(pid) 
FROM pg_stat_activity 
WHERE datname = current_database() 
  AND pid <> pg_backend_pid()
  AND usename = current_user  -- å…³é”®ï¼šåªæ¸…ç†è‡ªå·±çš„è¿æ¥
  AND state = 'idle'
  AND state_change < now() - interval '2 minutes';
```

**ä¼˜ç‚¹**ï¼š
- âœ… ä¸ä¼šè§¦å‘æƒé™é”™è¯¯
- âœ… å®‰å…¨ï¼Œä¸ä¼šå½±å“å…¶ä»–ç”¨æˆ·
- âœ… å¯ä»¥æ¸…ç†ä½ è‡ªå·±çš„æ³„æ¼è¿æ¥

---

### æ–¹æ¡ˆ 2: ç­‰å¾…è‡ªç„¶è¶…æ—¶ï¼ˆæœ€å®‰å…¨ï¼‰

Supabase ä¼šè‡ªåŠ¨æ¸…ç†ç©ºé—²è¿æ¥ï¼š

1. **æ£€æŸ¥è¶…æ—¶è®¾ç½®**ï¼š
   ```sql
   SHOW idle_in_transaction_session_timeout;
   ```

2. **ç­‰å¾…è¿æ¥è‡ªåŠ¨é‡Šæ”¾**ï¼š
   - ç©ºé—²è¿æ¥ä¼šåœ¨è¶…æ—¶åè‡ªåŠ¨å…³é—­
   - é€šå¸¸ä¸º 5-10 åˆ†é’Ÿ

3. **ç›‘æ§è¿æ¥æ•°**ï¼š
   ```sql
   SELECT count(*) 
   FROM pg_stat_activity 
   WHERE datname = current_database();
   ```

---

### æ–¹æ¡ˆ 3: é€šè¿‡ä»£ç ä¼˜åŒ–ï¼ˆæ ¹æœ¬è§£å†³ï¼‰

**å·²å®æ–½çš„ä¼˜åŒ–**ï¼ˆ`src/core/db/index.ts`ï¼‰ï¼š

1. âœ… **å…¨å±€å•ä¾‹**ï¼šé˜²æ­¢ HMR é‡å¤åˆ›å»ºè¿æ¥
2. âœ… **ç©ºé—²è¶…æ—¶**ï¼š20ç§’è‡ªåŠ¨é‡Šæ”¾
3. âœ… **è¿æ¥æ± é™åˆ¶**ï¼šå•ä¾‹æ¨¡å¼æœ€å¤š 10 ä¸ªè¿æ¥

**ç¯å¢ƒå˜é‡è®¾ç½®**ï¼š
```
DB_SINGLETON_ENABLED = true
```

**æ•ˆæœ**ï¼š
- è¿æ¥æ•°è‡ªåŠ¨æ§åˆ¶åœ¨åˆç†èŒƒå›´
- ä¸éœ€è¦æ‰‹åŠ¨æ¸…ç†
- è¿æ¥ä¼šè‡ªåŠ¨é‡Šæ”¾

---

## ğŸ” ç›‘æ§è¿æ¥çŠ¶æ€

### æŸ¥çœ‹æ‰€æœ‰è¿æ¥ï¼ˆåªè¯»ï¼Œå®‰å…¨ï¼‰

```sql
SELECT 
    usename,
    count(*) as connections,
    count(*) FILTER (WHERE state = 'idle') as idle
FROM pg_stat_activity 
WHERE datname = current_database()
GROUP BY usename;
```

### æŸ¥çœ‹ä½ çš„è¿æ¥

```sql
SELECT 
    pid,
    state,
    backend_start,
    state_change
FROM pg_stat_activity 
WHERE datname = current_database()
  AND usename = current_user;
```

---

## ğŸš€ æ¨èæ“ä½œæµç¨‹

### 1. ç«‹å³æ“ä½œï¼ˆä»£ç å·²ä¼˜åŒ–ï¼‰

**æ— éœ€æ‰‹åŠ¨æ¸…ç†**ï¼Œä»£ç ä¼˜åŒ–åï¼š
- è¿æ¥ä¼šè‡ªåŠ¨é‡Šæ”¾ï¼ˆ20ç§’ç©ºé—²è¶…æ—¶ï¼‰
- è¿æ¥æ•°ä¼šè¢«é™åˆ¶ï¼ˆæœ€å¤š 10 ä¸ªï¼‰
- HMR ä¸ä¼šé‡å¤åˆ›å»ºè¿æ¥

### 2. å¦‚æœè¿æ¥æ•°ä»ç„¶å¾ˆé«˜

**æ£€æŸ¥ç¯å¢ƒå˜é‡**ï¼š
- âœ… `DB_SINGLETON_ENABLED = true` å·²è®¾ç½®
- âœ… `DATABASE_URL` ä½¿ç”¨ Pooler (6543ç«¯å£)

**é‡æ–°éƒ¨ç½²**ï¼š
- åœ¨ Vercel ç‚¹å‡» Redeploy
- æ–°éƒ¨ç½²ä¼šä½¿ç”¨ä¼˜åŒ–åçš„ä»£ç 

### 3. ç›‘æ§è¿æ¥è¶‹åŠ¿

ä½¿ç”¨ `scripts/monitor_db_connections.sql`ï¼š
- æ¯å¤©æ£€æŸ¥ä¸€æ¬¡è¿æ¥æ•°
- ç¡®è®¤è¿æ¥æ•°åœ¨ä¸‹é™
- å¦‚æœæŒç»­å¢é•¿ï¼Œæ£€æŸ¥ä»£ç æ˜¯å¦æœ‰æ³„æ¼

---

## ğŸ“Š é¢„æœŸè¿æ¥æ•°

**æ­£å¸¸èŒƒå›´**ï¼š
- å¼€å‘ç¯å¢ƒï¼š5-15 ä¸ªè¿æ¥
- ç”Ÿäº§ç¯å¢ƒï¼š10-30 ä¸ªè¿æ¥ï¼ˆå–å†³äºå¹¶å‘ï¼‰

**å¼‚å¸¸æƒ…å†µ**ï¼š
- è¶…è¿‡ 50 ä¸ªï¼šå¯èƒ½æœ‰è¿æ¥æ³„æ¼
- è¶…è¿‡ 100 ä¸ªï¼šéœ€è¦ç«‹å³æ£€æŸ¥

---

## ğŸ†˜ å¦‚æœè¿æ¥æ•°ä»ç„¶å¾ˆé«˜

### æ£€æŸ¥æ¸…å•

1. **ç¯å¢ƒå˜é‡**ï¼š
   - [ ] `DB_SINGLETON_ENABLED = true`
   - [ ] `DATABASE_URL` ä½¿ç”¨ Pooler (6543ç«¯å£)

2. **ä»£ç éƒ¨ç½²**ï¼š
   - [ ] å·²é‡æ–°éƒ¨ç½²æœ€æ–°ä»£ç 
   - [ ] éƒ¨ç½²æ—¥å¿—æ— é”™è¯¯

3. **è¿æ¥ç›‘æ§**ï¼š
   - [ ] è¿è¡Œ `scripts/monitor_db_connections.sql`
   - [ ] æŸ¥çœ‹æ˜¯å¦æœ‰é•¿æ—¶é—´ç©ºé—²çš„è¿æ¥

4. **Supabase è®¾ç½®**ï¼š
   - [ ] Pooling Mode = Transaction
   - [ ] ä¸æ˜¯ Session æ¨¡å¼

---

## ğŸ’¡ é‡è¦æç¤º

**åœ¨ Supabase ä¸­**ï¼š
- âŒ æ— æ³•ç»ˆæ­¢å…¶ä»–ç”¨æˆ·çš„è¿æ¥ï¼ˆæƒé™é™åˆ¶ï¼‰
- âœ… åªèƒ½ç»ˆæ­¢è‡ªå·±çš„è¿æ¥
- âœ… è¿æ¥ä¼šè‡ªåŠ¨è¶…æ—¶é‡Šæ”¾
- âœ… ä»£ç ä¼˜åŒ–æ˜¯æ ¹æœ¬è§£å†³æ–¹æ¡ˆ

**æœ€ä½³å®è·µ**ï¼š
1. ä½¿ç”¨ä»£ç ä¼˜åŒ–ï¼ˆå·²å®æ–½ï¼‰
2. è®¾ç½®æ­£ç¡®çš„ç¯å¢ƒå˜é‡
3. ç›‘æ§è¿æ¥è¶‹åŠ¿
4. ç­‰å¾…è‡ªç„¶è¶…æ—¶ï¼ˆå¦‚æœéœ€è¦ï¼‰

---

**æ€»ç»“**ï¼šæƒé™é”™è¯¯æ˜¯æ­£å¸¸çš„ã€‚ä»£ç ä¼˜åŒ–åï¼Œè¿æ¥ä¼šè‡ªåŠ¨ç®¡ç†ï¼Œæ— éœ€æ‰‹åŠ¨æ¸…ç†ã€‚ğŸ‰
