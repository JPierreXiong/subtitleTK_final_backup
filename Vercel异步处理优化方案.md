# Vercel å¼‚æ­¥å¤„ç†ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜åˆ†æ

### æ ¸å¿ƒç—›ç‚¹
- **Vercel Free ç‰ˆ**ï¼š10ç§’å¼ºåˆ¶è¶…æ—¶
- **Vercel Pro ç‰ˆ**ï¼š30ç§’ï¼ˆå¯é…ç½®åˆ°300ç§’ï¼‰
- **è§†é¢‘å¤„ç†**ï¼šéœ€è¦1-3åˆ†é’Ÿ
- **å½“å‰æ–¹æ¡ˆ**ï¼šä½¿ç”¨ `setTimeout`ï¼Œåœ¨ Vercel Serverless ä¸­å¯èƒ½ä¸å¯é 

### ç°æœ‰å®ç°åˆ†æ
1. âœ… å·²æœ‰ Worker/Queue æ¶æ„ï¼ˆQStashï¼‰ï¼Œä½†éœ€è¦é…ç½®
2. âœ… å·²æœ‰ `setTimeout` é™çº§æ–¹æ¡ˆ
3. âš ï¸ `setTimeout` åœ¨ Vercel ä¸­å¯èƒ½è¢«å†»ç»“ï¼Œå¯¼è‡´ä»»åŠ¡ä¸¢å¤±

---

## ğŸš€ ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆæ¶æ„

```
ç”¨æˆ·æäº¤ â†’ API A (submit) â†’ ç«‹å³è¿”å› taskId
                â†“
        è§¦å‘å†…éƒ¨å¤„ç†æ¥å£ (ä¸ç­‰å¾…)
                â†“
        API B (process-internal) â†’ æ‰§è¡Œé•¿ä»»åŠ¡
                â†“
        æ›´æ–°æ•°æ®åº“çŠ¶æ€
                â†“
        å‰ç«¯è½®è¯¢çŠ¶æ€
```

### æ ¸å¿ƒæ€è·¯

1. **åˆ†ç¦»æäº¤å’Œå¤„ç†**ï¼šå°†æäº¤æ¥å£å’Œå¤„ç†é€»è¾‘åˆ†ç¦»
2. **ä½¿ç”¨å†…éƒ¨æ¥å£**ï¼šé€šè¿‡ fetch è§¦å‘å†…éƒ¨å¤„ç†æ¥å£ï¼Œç¡®ä¿åœ¨ç‹¬ç«‹å®ä¾‹ä¸­æ‰§è¡Œ
3. **åˆ©ç”¨ waitUntil**ï¼šå¦‚æœæ”¯æŒï¼Œä½¿ç”¨ waitUntil ç¡®ä¿ä»»åŠ¡æ‰§è¡Œ
4. **ä¿æŒå…¼å®¹æ€§**ï¼šä¿ç•™ç°æœ‰ Worker/Queue å’Œ setTimeout é™çº§æ–¹æ¡ˆ

---

## ğŸ”§ å®æ–½æ­¥éª¤

### Step 1: åˆ›å»ºå†…éƒ¨å¤„ç†æ¥å£

**æ–‡ä»¶ï¼š** `src/app/api/media/process-internal/route.ts`

**ä½œç”¨ï¼š**
- æ¥æ”¶ä»»åŠ¡IDï¼Œæ‰§è¡Œé•¿ä»»åŠ¡å¤„ç†
- ä¸å—æäº¤æ¥å£è¶…æ—¶é™åˆ¶
- å¯ä»¥è®¾ç½®æ›´é•¿çš„è¶…æ—¶æ—¶é—´ï¼ˆå¦‚æœä½¿ç”¨ Pro ç‰ˆï¼‰

### Step 2: ä¼˜åŒ–æäº¤æ¥å£

**æ–‡ä»¶ï¼š** `src/app/api/media/submit/route.ts`

**æ”¹è¿›ï¼š**
- åˆ›å»ºä»»åŠ¡åï¼Œé€šè¿‡ fetch è§¦å‘å†…éƒ¨å¤„ç†æ¥å£
- ä½¿ç”¨ waitUntilï¼ˆå¦‚æœæ”¯æŒï¼‰ç¡®ä¿ä»»åŠ¡æ‰§è¡Œ
- ä¿ç•™ Worker/Queue å’Œ setTimeout é™çº§æ–¹æ¡ˆ

### Step 3: å¢å¼ºé”™è¯¯å¤„ç†

- ç¡®ä¿ä»»åŠ¡å¤±è´¥æ—¶èƒ½æ­£ç¡®æ›´æ–°çŠ¶æ€
- ç¡®ä¿ç§¯åˆ†é€€æ¬¾é€»è¾‘æ­£ç¡®æ‰§è¡Œ

---

## ğŸ’¡ æŠ€æœ¯ç»†èŠ‚

### 1. waitUntil ä½¿ç”¨ï¼ˆå¦‚æœæ”¯æŒï¼‰

```typescript
// æ£€æµ‹æ˜¯å¦æ”¯æŒ waitUntil
if (typeof request.waitUntil === 'function') {
  request.waitUntil(
    processInternalTask(taskId, url, outputType, userId)
  );
}
```

### 2. å†…éƒ¨æ¥å£è§¦å‘

```typescript
// è§¦å‘å†…éƒ¨å¤„ç†æ¥å£ï¼ˆä¸ç­‰å¾…å“åº”ï¼‰
fetch(`${process.env.NEXT_PUBLIC_SITE_URL}/api/media/process-internal`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ taskId, url, outputType, userId }),
}).catch(err => {
  // å¦‚æœè§¦å‘å¤±è´¥ï¼Œä½¿ç”¨ setTimeout é™çº§
  console.error('[Process Internal Trigger Failed]', err);
});
```

### 3. å¤šå±‚é™çº§ç­–ç•¥

```
ä¼˜å…ˆçº§ 1: Worker/Queue (QStash) - æœ€å¯é 
ä¼˜å…ˆçº§ 2: å†…éƒ¨æ¥å£ (process-internal) - æ¬¡å¯é 
ä¼˜å…ˆçº§ 3: setTimeout - é™çº§æ–¹æ¡ˆ
```

---

## âœ… ä¼˜åŠ¿

1. **ä¸æ”¹å˜ ShipAny ç»“æ„**ï¼šåªæ·»åŠ æ–°æ¥å£ï¼Œä¸ä¿®æ”¹æ ¸å¿ƒé€»è¾‘
2. **å‘åå…¼å®¹**ï¼šä¿ç•™ç°æœ‰ Worker/Queue å’Œ setTimeout æ–¹æ¡ˆ
3. **å¯é æ€§æå‡**ï¼šå¤šå±‚é™çº§ç¡®ä¿ä»»åŠ¡æ‰§è¡Œ
4. **æ˜“äºç»´æŠ¤**ï¼šæ¸…æ™°çš„èŒè´£åˆ†ç¦»

---

## ğŸ“ å®æ–½æ¸…å•

- [ ] åˆ›å»º `src/app/api/media/process-internal/route.ts`
- [ ] ä¼˜åŒ– `src/app/api/media/submit/route.ts`
- [ ] æµ‹è¯•å¤šå±‚é™çº§ç­–ç•¥
- [ ] éªŒè¯é”™è¯¯å¤„ç†é€»è¾‘
